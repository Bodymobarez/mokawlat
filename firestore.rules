rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check for admin role
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users can read their own profile, admins can read any profile
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // A user can create their own document, but cannot assign themselves as admin.
      allow create: if request.auth != null && request.auth.uid == userId && request.resource.data.role == 'user';
      // Only admins can update user documents (e.g. to change roles)
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Admins have full access to most collections.
    // Regular authenticated users have read-only access.
    match /{collection}/{docId} where collection in ['projects', 'employees', 'suppliers', 'inventory', 'procurement', 'clients', 'accounts', 'activityLog'] {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Special rules for subcollections or collections with user write access

    // Client Interactions: Any authenticated user can add an interaction. Only admins can edit/delete.
    match /clients/{clientId}/interactions/{interactionId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if isAdmin();
    }
    
    // Client Contracts: Only admins can manage contracts.
    match /clients/{clientId}/contracts/{contractId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }

    // Supplier Contracts: Only admins can manage contracts.
    match /suppliers/{supplierId}/contracts/{contractId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    
    // Material Requests: Any authenticated user can create a request. Only admins can update/delete.
    match /materialRequests/{requestId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if isAdmin();
    }

    // Transactions: Only admins can manage transactions.
    match /transactions/{transactionId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
  }
}
