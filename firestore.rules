rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users:
    // - Read: Authenticated users can read their own profile.
    // - Write: Authenticated users can only create their own profile. Admins can edit any profile.
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAdmin();
    }
    
    // Projects:
    // - Read: Any authenticated user can read projects.
    // - Write: Only admins can create, update, delete projects.
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();

      // Daily Logs Subcollection:
      // - Read: Any authenticated user can read logs.
      // - Create: Any authenticated user can create a log.
      // - Write (Update/Delete): Only admins can modify/delete logs.
      match /dailyLogs/{logId} {
        allow read, create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
      
      // Documents Subcollection:
      // - Read: Any authenticated user can read document details.
      // - Create, Delete: Any authenticated user can manage documents.
      match /documents/{documentId} {
        allow read, create, delete: if isAuthenticated();
      }
    }
    
    // Employees:
    // - Read: Any authenticated user can read employee data.
    // - Write: Only admins can manage employees.
    match /employees/{employeeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Suppliers:
    // - Read: Any authenticated user can read supplier data.
    // - Write: Only admins can manage suppliers.
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      // Contracts Subcollection:
      // - Read: Authenticated users can read.
      // - Write: Admins can write.
      match /contracts/{contractId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
    }
    
    // Inventory:
    // - Read: Any authenticated user can read inventory data.
    // - Write: Only admins can manage inventory items.
    match /inventory/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Inventory Categories:
    // - Read: Any authenticated user can read categories.
    // - Write: Only admins can manage categories.
    match /inventoryCategories/{categoryId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }

    // Procurement:
    // - Read: Any authenticated user can read procurement data.
    // - Write: Only admins can manage procurement requests.
    match /procurement/{requestId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Material Requests:
    // - Read: Authenticated users can read requests.
    // - Create: Authenticated users can create requests.
    // - Update: Admins can update requests.
    match /materialRequests/{requestId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Clients:
    // - Read: Authenticated users can read.
    // - Write: Admins can create/update/delete clients.
    match /clients/{clientId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      // Interactions Subcollection:
      // - Read, Create: Authenticated users can log interactions.
      // - Update, Delete: Only admins can modify/delete past interactions.
      match /interactions/{interactionId} {
        allow read, create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
      
      // Contracts Subcollection:
      // - Read: Authenticated users can read.
      // - Write: Admins can write.
      match /contracts/{contractId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
    }
    
    // Accounts:
    // - Read: Authenticated users can read bank accounts.
    // - Write: Only admins can manage bank accounts.
    match /accounts/{accountId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }

    // Transactions:
    // - Read: Authenticated users can read transactions.
    // - Write: Only admins can manage transactions.
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Activity Log:
    // - Read: Any authenticated user can read the log.
    // - Create: Any authenticated user can create log entries (via server actions).
    // - Write: No one can update/delete logs to ensure audit trail integrity.
    match /activityLog/{logId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if false;
    }
  }
}
