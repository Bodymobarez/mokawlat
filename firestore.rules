
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      // Check if the user is authenticated and their user document has the 'admin' role.
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Default deny all to ensure explicit rules are set for every path.
    match /{document=**} {
      allow read, write: if false;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Admins can list all users for the user management page.
      allow list: if isAdmin();
      
      // An admin can get any user's profile. A user can only get their own.
      allow get: if isAdmin() || (isAuth() && request.auth.uid == userId);
      
      // Only admins can create, update, or delete users.
      allow write: if isAdmin();
    }
    
    // Rules for most top-level data collections.
    // Any authenticated user can read (get or list) from these collections.
    // Only admins can write (create, update, delete).
    match /{collection}/{id}
        where collection in ['projects', 'employees', 'clients', 'suppliers', 'inventory', 'inventoryCategories', 'warehouses', 'assets', 'procurement', 'materialRequests', 'invoices', 'accounts', 'activityLog', 'company'] {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // Rules for sub-collections. These are simplified for now.
    // A more robust implementation would check for project membership, etc.
    match /projects/{projectId}/{subcollection}/{documentId}
      where subcollection in ['tasks', 'documents', 'dailyLogs'] {
      allow read, write: if isAuth();
    }
    
    match /clients/{clientId}/{subcollection}/{documentId}
      where subcollection in ['interactions', 'contracts'] {
      allow read, write: if isAuth();
    }
    
    match /suppliers/{supplierId}/{subcollection}/{documentId}
        where subcollection in ['contracts'] {
        allow read, write: if isAuth();
    }
    
    match /assets/{assetId}/maintenanceLogs/{logId} {
        allow read, write: if isAuth();
    }

    // This rule enables collection group queries on 'contracts'.
    // Required for the financials page to link transactions to contracts.
    match /{path=**}/contracts/{contractId} {
      allow read: if isAuth();
    }
  }
}
